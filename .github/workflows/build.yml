name: Build Validation

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm ci
        
    - name: Build project
      run: |
        echo "Building project..."
        npm run build
      env:
        NODE_ENV: production
        
    - name: Verify build output
      run: |
        echo "Verifying build output..."
        
        # æ£€æŸ¥æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
        if [ -d "./dist" ]; then
          echo "âœ… Build directory exists"
          ls -la ./dist
          
          # æ£€æŸ¥æ„å»ºç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A ./dist)" ]; then
            echo "âŒ Error: Build directory is empty!"
            exit 1
          else
            echo "âœ… Build directory contains files"
            echo "ğŸ“Š Build size: $(du -sh ./dist | awk '{print $1}')"
          fi
        elif [ -d "./build" ]; then
          echo "âœ… Build directory (build) exists"
          ls -la ./build
          
          if [ -z "$(ls -A ./build)" ]; then
            echo "âŒ Error: Build directory is empty!"
            exit 1
          else
            echo "âœ… Build directory contains files"
            echo "ğŸ“Š Build size: $(du -sh ./build | awk '{print $1}')"
          fi
        else
          echo "âš ï¸ Warning: No standard build directory found"
          echo "Looking for common build directories..."
          find . -type d \( -name "dist" -o -name "build" -o -name "out" \) -maxdepth 2
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          ./dist
          ./build
          ./out
        if-no-files-found: warn
